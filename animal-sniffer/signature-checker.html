<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2015-08-02 
 | Rendered using Apache Maven Fluido Skin 1.4
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Kohsuke Kawaguchi" />
    <meta name="Date-Creation-yyyymmdd" content="20081115" />
    <meta name="Date-Revision-yyyymmdd" content="20150802" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Animal Sniffer &#x2013; Signature Checker</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.4.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.4.min.js"></script>

    
                  </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="https://github.com/mojohaus/mojo-parent">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                                  <a href="../../" id="bannerLeft">
                                                                                                <img src="../../images/mojo_logo.png"  alt="MojoHaus"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="../../" title="MojoHaus">
        MojoHaus</a>
                    <span class="divider">/</span>
      </li>
            <li class="">
                    <a href="../../mojo-parent" title="MojoHaus Parent">
        MojoHaus Parent</a>
                    <span class="divider">/</span>
      </li>
                <li class="">
                    <a href="./" title="Animal Sniffer">
        Animal Sniffer</a>
                    <span class="divider">/</span>
      </li>
        <li class="active ">Signature Checker</li>
        
                
                    
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2015-08-02</li>
              <li id="projectVersion" class="pull-right">
                      <span class="divider">|</span>
                    Version: 1.15-SNAPSHOT
        </li>
            
                                    
    <li class="pull-right">
                      <a href="http://maven.apache.org/" class="externalLink" title="Maven">
        Maven</a>
      </li>

                    </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Overview</li>
                              
      <li>
  
                          <a href="index.html" title="Introduction">
          <span class="none"></span>
        Introduction</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                        
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-right"></span>
        Project Information</a>
                  </li>
                                                                                                                                                                                                                  
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <span class="icon-chevron-right"></span>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                            <form id="search-form" action="https://www.google.com/search" method="get" >
    
  <input value="www.mojohaus.org" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="https://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span10" >
                                  
            <!-- The MIT License --><!--  --><!-- Copyright (c) 2008 Kohsuke Kawaguchi and codehaus.org. --><!--  --><!-- Permission is hereby granted, free of charge, to any person obtaining a copy --><!-- of this software and associated documentation files (the "Software"), to deal --><!-- in the Software without restriction, including without limitation the rights --><!-- to use, copy, modify, merge, publish, distribute, sublicense, and/or sell --><!-- copies of the Software, and to permit persons to whom the Software is --><!-- furnished to do so, subject to the following conditions: --><!--  --><!-- The above copyright notice and this permission notice shall be included in --><!-- all copies or substantial portions of the Software. --><!--  --><!-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR --><!-- IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, --><!-- FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE --><!-- AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER --><!-- LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, --><!-- OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN --><!-- THE SOFTWARE. --><!--  --><div class="section">
<h2><a name="What_is_this"></a>What is this?</h2>
<p>It's common for a Java project to compile with later versions of JDK than it minimally requires. For example, when Hudson runs on Java6 it takes advantages of those features, but it can also run on Java5 without those advanced features.</p>
<p>The technique to do this is well understood. Here's one such code fragment taken from Hudson:</p>
<div>
<pre>try {
    for (ThreadInfo ti : Functions.getThreadInfos())
        r.put(ti.getThreadName(),Functions.dumpThreadInfo(ti));
} catch (LinkageError _) {
    // not in JDK6. fall back to JDK5
    ...
}</pre></div>
<p>This is desirable, since you can take advantages of the latest JavaSE features without forcing users to upgrade.</p>
<p>The problem is that you now need to compile with JDK6, so when other parts of code accidentally depends on new additions in Java6 and breaks the minimum Java5 requirement, your build process won't complain.</p>
<p>If you are lucky, your tests will catch it, but no test attain 100% of code coverage, so there's still a good chance that such a problem slips into the production code. (For example, I've been bitten a few times by using <tt>IOException(String,Throwable)</tt> constructor that was added in 1.6, since I typically use it only in handling errors that tend not to be tested well.)</p></div>
<div class="section">
<h2><a name="Animal_sniffer_to_the_rescue"></a>Animal sniffer to the rescue</h2>
<p>The idea of the tool is simple. I first run a &quot;signature builder&quot; with various versions of JREs, capturing all the method and field signatures from them. Those are then uploaded into a Maven repository to be downloaded later by your Maven.</p>
<p>I then wrote a separate tool called &quot;signature checker&quot;, which uses this signature file and inspect your classes. If your classes depend on things that don't exist in the signature list, you get an error message. This tool is packaged up as a Maven plugin, so to use this, you just add the following snippet inside your &lt;build&gt; element in <tt>pom.xml</tt>:</p>
<div>
<pre>&lt;plugin&gt;
  &lt;!-- make sure our code doesn't have 1.6 dependencies except where we know it --&gt;
  &lt;groupId&gt;org.jvnet&lt;/groupId&gt;
  &lt;artifactId&gt;animal-sniffer&lt;/artifactId&gt;
  &lt;version&gt;1.2&lt;/version&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;goals&gt;
        &lt;goal&gt;check&lt;/goal&gt;
      &lt;/goals&gt;
      &lt;configuration&gt;
        &lt;signature&gt;
          &lt;groupId&gt;org.jvnet.animal-sniffer&lt;/groupId&gt;
          &lt;artifactId&gt;java1.5&lt;/artifactId&gt;
          &lt;version&gt;1.0&lt;/version&gt;
        &lt;/signature&gt;
      &lt;/configuration&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;</pre></div>
<p>The nested &lt;signature&gt; element specifies the signature list to use. In addition to java1.5, <a class="externalLink" href="http://maven.dyndns.org/2/org/jvnet/animal-sniffer/">java1.3, java1.4, and java1.6 available</a>.</p></div>
<div class="section">
<h2><a name="Running_this_less_often"></a>Running this less often</h2>
<p>If you don't want to do this for every Maven build, you can instead have the following snippet:</p>
<div>
<pre>&lt;plugin&gt;
  &lt;!-- make sure our code doesn't have 1.6 dependencies except where we know it --&gt;
  &lt;groupId&gt;org.jvnet&lt;/groupId&gt;
  &lt;artifactId&gt;animal-sniffer&lt;/artifactId&gt;
  &lt;version&gt;1.2&lt;/version&gt;
  &lt;configuration&gt;
    &lt;signature&gt;
      &lt;groupId&gt;org.jvnet.animal-sniffer&lt;/groupId&gt;
      &lt;artifactId&gt;java1.5&lt;/artifactId&gt;
      &lt;version&gt;1.0&lt;/version&gt;
    &lt;/signature&gt;
  &lt;/configuration&gt;
&lt;/plugin&gt;</pre></div>
<p>And then you can run <tt>mvn compile animal-sniffer:check</tt> to check the dependency, or you can further add the following POM snippet so that the check is performed automatically during a release:</p>
<div>
<pre>&lt;plugin&gt;
  &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt;
  &lt;configuration&gt;
    &lt;goals&gt;install animal-sniffer:check deploy&lt;/goals&gt;
  &lt;/configuration&gt;
&lt;/plugin&gt;</pre></div>
<p>The tool uses ASM and statically analyze the code, so it doesn't miss any reference, unlike test based approach.</p></div>
<div class="section">
<h2><a name="Marking_dependencies_explicitly"></a>Marking dependencies explicitly</h2>
<p>Now, in the places where you knowingly use features that go beyond the minimum requirement, you put the <tt>@IgnoreJRERequirement</tt> annotation on a method. This is a signal from you to the checker that you're aware of the dependency there and you know what you are doing.</p>
<p>For this code to compile, you need to add <tt>animal-sniffer.jar</tt> to the dependency list. This annotation is configured as <tt>@Retention(CLASS)</tt>, so you don't need this jar to be at runtime. To tell Maven not to put it in the runtime, this fragment includes <tt>&lt;optional&gt;true&lt;/optional&gt; </tt>:</p>
<div>
<pre>&lt;dependency&gt;
  &lt;!-- for JRE requirement check annotation --&gt;
  &lt;groupId&gt;org.jvnet&lt;/groupId&gt;
  &lt;artifactId&gt;animal-sniffer&lt;/artifactId&gt;
  &lt;version&gt;1.2&lt;/version&gt;
  &lt;optional&gt;true&lt;/optional&gt;
&lt;/dependency&gt;</pre></div>
<p>There are certain edge cases that this tool doesn't handle correctly (like the case when a visibility of a method changes from 'protected' to 'public' between Java5 to Java6 --- not that I know such a case exists), but I think it runs pretty well, at least on Hudson, and the added peace of mind is priceless.</p>
<p>As usual, I'm always looking for more people to work on any of my projects, so if you are interested, please send me an e-mail, and you'll be a committer right away.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                    2008&#x2013;2015
                        <a href="http://www.mojohaus.org">MojoHaus</a>.
            All rights reserved.      
                    
      </p>
                </div>

        
          
    
    
                
    <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="https://www.ohloh.net/p/5211/widgets/project_thin_badge.js"></script>
    </div>
        </div>
    </footer>
        </body>
</html>